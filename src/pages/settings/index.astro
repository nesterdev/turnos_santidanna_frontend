---
import DashboardLayout from "../../components/layouts/DashboardLayout.astro";
import { apiFetch } from "../../lib/utils/fetch.js";

let settings = {};
let error = "";

try {
  settings = await apiFetch("/settings");
} catch (err) {
  console.error("Error cargando settings:", err);
  error = "No se pudieron cargar las configuraciones.";
}
---

<DashboardLayout title="Configuración del Sistema">

  <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow space-y-6">

    <h1 class="text-2xl font-semibold mb-4">Configuraciones del Sistema</h1>

    {error && (
      <p class="p-3 bg-red-100 text-red-600 rounded">{error}</p>
    )}

    <form id="settingsForm" class="space-y-4">

      <!-- Nombre del Sistema -->
      <div>
        <label class="block text-sm font-medium mb-1">Nombre del Sistema</label>
        <input 
          name="systemName"
          type="text"
          required
          value={settings.systemName || ""}
          class="input"
        />
      </div>

      <!-- Zona Horaria -->
      <div>
        <label class="block text-sm font-medium mb-1">Zona Horaria</label>
        <input 
          name="timezone"
          type="text"
          required
          value={settings.timezone || ""}
          class="input"
        />
      </div>

      <!-- Días laborales por defecto -->
      <div>
        <label class="block text-sm font-medium mb-1">Días laborales por defecto</label>
        <input 
          name="workDays"
          type="number"
          min="1"
          max="7"
          required
          value={settings.workDays ?? 5}
          class="input"
        />
      </div>

      <!-- SUBMIT -->
      <button
        type="submit"
        class="px-5 py-2 bg-[#FF3131] text-white rounded hover:bg-[#FF3232]"
      >
        Guardar cambios
      </button>

    </form>

    <p id="statusMsg" class="text-sm mt-3"></p>
  </div>

  <style>
    .input {
      @apply w-full border rounded px-3 py-2 shadow-sm focus:ring focus:border-blue-400;
    }
  </style>

  <script>
    const form = document.getElementById("settingsForm");
    const statusMsg = document.getElementById("statusMsg");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      statusMsg.textContent = "Guardando...";
      statusMsg.className = "text-[#FF3131]";

      const payload = Object.fromEntries(new FormData(form));

      const res = await fetch("/api/update-settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json();

      if (data.success) {
        statusMsg.textContent = "Configuraciones actualizadas correctamente.";
        statusMsg.className = "text-green-600";
      } else {
        statusMsg.textContent =
          data.message || "Error actualizando las configuraciones.";
        statusMsg.className = "text-red-600";
      }
    });
  </script>

</DashboardLayout>
